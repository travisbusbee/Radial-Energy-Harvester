DVAR $hFile
DVAR $cCheck
DVAR $press
DVAR $length
DVAR $lame
DVAR $comport


DVAR $found, $floor $delta $deltafast $Ax $Ay $Bx $By $Cx $Cy $Dx $Dy $Px $Py $posA $posB $posC $posD $posZ $fastfeed $midfeed $slowfeed $Astart $Bstart $Cstart $Dstart $Pstart $comma1 $comma2 $comma1plus $comma2plus
DVAR $Ax_dif $Ay_dif $Bx_dif $By_dif $Cx_dif $Cy_dif $Dx_dif $Dy_dif $Px_dif $Py_dif
DVAR $nozzle $nozzleA $nozzleB $nozzleC $nozzleD $profilometerRod $xStart $yStart $zStart 
DVAR $zMeasureA $zMeasureB $zMeasureC $zMeasureD $Az_dif $Bz_dif $Cz_dif $Dz_dif $xOffset $yOffset
DVAR $zA $zB $zC $zD $check
DVAR $zSweepRange $zSweepStep $numsteps $tempdistance $zDwell $count $z_dif $z_past $z_num $indicator $step $start $x_dist
DVAR $align_save
FILECLOSE 

$floor = -72
$deltafast = 1
$delta = 0.1
$fastfeed = 40
$midfeed = 10
$slowfeed = 2
$Astart = -15
$Bstart = -15
$Cstart = -15
$Dstart = -15
$Pstart = -15
$nozzleA=1
$nozzleB=2
$nozzleC=3
$nozzleD=4
$profilometerRod = 5

$Ax = 586.075
$Ay = 367.8285
$Bx = 482.075
$By = 367.8285
$Cx = 378.075
$Cy = 367.8285
$Dx = 299.075
$Dy = 367.8285
$Px = 148
$Py = 345

$DO0.0=0
$DO1.0=0
$DO2.0=0
$DO3.0=0
Primary ; sets primary units mm and s
G65 F2000; accel speed mm/s^2
G66 F2000;accel speed mm/s^2
ENABLE X Y A B C D U
POSOFFSET CLEAR X Y U A B C D
G91 ;start off in relative mode

G90
G1 X0.298417 Y11.396094
G91
G90
G17
G2 Y10.454484848 X4.54573938575 R11.4
G17
G91
G90
G1 X4.864739 Y11.188133
G91
G90
G17
G3 Y12.1958193647 X0.319358769356 R12.2
G17
G91
G90
G1 X0.340300 Y12.995545
G91
G90
G1 X0.340300 Y12.995545
G91
G90
G17
G2 Y11.921780967 X5.18373789603 R13.0
G17
G91
G90
G1 X5.502737 Y12.655429
G91
G90
G17
G3 Y13.7952710847 X0.361241886649 R13.8
G17
G91
G90
G1 X0.382183 Y14.594997
G91
G90
G1 X0.382183 Y14.594997
G91
G90
G17
G2 Y13.389077086 X5.82173640631 R14.6
G17
G91
G90
G1 X6.140736 Y14.122725
G91
G90
G17
G3 Y15.3947228046 X0.403125003941 R15.4
G17
G91
G90
G1 X0.424067 Y16.194449
G91
G90
G1 X0.424067 Y16.194449
G91
G90
G17
G2 Y14.856373205 X6.45973491659 R16.2
G17
G91
G90
G1 X6.778734 Y15.590021
G91
G90
G17
G3 Y16.9941745246 X0.445008121234 R17.0
G17
G91
G90
G1 X0.465950 Y17.793900
G91
G90
G1 X0.465950 Y17.793900
G91
G90
G17
G2 Y16.3236693241 X7.09773342687 R17.8
G17
G91
G90
G1 X7.416733 Y17.057317
G91
G90
G17
G3 Y18.5936262445 X0.486891238526 R18.6
G17
G91
G90
G1 X0.507833 Y19.393352
G91
G90
G1 X0.507833 Y19.393352
G91
G90
G17
G2 Y17.7909654431 X7.73573193715 R19.4
G17
G91
G90
G1 X8.054731 Y18.524614
G91
G90
G17
G3 Y20.1930779645 X0.528774355819 R20.2
G17
G91
G90
G1 X0.549716 Y20.992804
G91
G90
G1 X0.549716 Y20.992804
G91
G90
G17
G2 Y19.2582615621 X8.37373044743 R21.0
G17
G91
G90
G1 X8.692730 Y19.991910
G91
G90
G17
G3 Y21.7925296845 X0.570657473112 R21.8
G17
G91
G90
G1 X0.591599 Y22.592256
G91
G90
G1 X0.591599 Y22.592256
G91
G90
G17
G2 Y20.7255576811 X9.01172895771 R22.6
G17
G91
G90
G1 X9.330728 Y21.459206
G91
G90
G17
G3 Y23.3919814044 X0.612540590404 R23.4
G17
G91
G90
G1 X0.633482 Y24.191707
G91
G90
G1 X0.633482 Y24.191707
G91
G90
G17
G2 Y22.1928538001 X9.64972746799 R24.2
G17
G91
G90
G1 X9.968727 Y22.926502
G91
G90
G17
G3 Y24.9914331244 X0.654423707697 R25.0
G17
G91
G90
G1 X0.675365 Y25.791159
G91
G90
G1 X0.675365 Y25.791159
G91
G90
G17
G2 Y23.6601499191 X10.2877259783 R25.8
G17
G91
G90
G1 X10.606725 Y24.393798
G91
G90
G17
G3 Y26.5908848443 X0.696306824989 R26.6
G17
G91
G90
G1 X0.717248 Y27.390611
G91
G90
G1 X0.717248 Y27.390611
G91
G90
G17
G2 Y25.1274460382 X10.9257244886 R27.4
G17
G91
G90
G1 X11.244724 Y25.861094
G91
G90
G17
G3 Y28.1903365643 X0.738189942282 R28.2
G17
G91
G90
G1 X0.759132 Y28.990062
G91
G90
G1 X0.759132 Y28.990062
G91
G90
G17
G2 Y26.5947421572 X11.5637229988 R29.0
G17
G91
G90
G1 X11.882722 Y27.328390
G91
G90
G17
G3 Y29.7897882843 X0.780073059575 R29.8
G17
G91
G90
G1 X0.801015 Y30.589514
G91
G90
G1 X0.801015 Y30.589514
G91
G90
G17
G2 Y28.0620382762 X12.2017215091 R30.6
G17
G91
G90
G1 X12.520721 Y28.795686
G91
G90
G17
G3 Y31.3892400042 X0.821956176867 R31.4
G17
G91
G90
G1 X0.842898 Y32.188966
G91
G90
G1 X0.842898 Y32.188966
G91
G90
G17
G2 Y29.5293343952 X12.8397200194 R32.2
G17
G91
G90
G1 X13.158719 Y30.262982
G91
G90
G17
G3 Y32.9886917242 X0.86383929416 R33.0
G17
G91
G90
G1 X0.884781 Y33.788418
G91
G90
G1 X0.884781 Y33.788418
G91
G90
G17
G2 Y30.9966305142 X13.4777185297 R33.8
G17
G91
G90
G1 X13.796718 Y31.730279
G91
G90
G17
G3 Y34.5881434442 X0.905722411452 R34.6
G17
G91
G90
G1 X0.926664 Y35.387869
G91
G90
G1 X0.926664 Y35.387869
G91
G90
G17
G2 Y32.4639266332 X14.11571704 R35.4
G17
G91
G90
G1 X14.434716 Y33.197575
G91
G90
G17
G3 Y36.1875951641 X0.947605528745 R36.2
G17
G91
G90
G1 X0.968547 Y36.987321
G91
G90
G1 X0.968547 Y36.987321
G91
G90
G17
G2 Y33.9312227522 X14.7537155502 R37.0
G17
G91
G90
G1 X15.072715 Y34.664871
G91
G90
G17
G3 Y37.7870468841 X0.989488646038 R37.8
G17
G91
;#################################### Code ##########################################

M2

;##########Functions############;
DFS setPress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000
                             
        $press = $Q * 10.0                             
        $strtask2 = DBLTOSTR( $press , 0 )  
      
      
        $length = STRLEN( $strtask2 )      
        WHILE $length < 4.0
                $strtask2 = "0" + $strtask2    
                $length = STRLEN( $strtask2 ) 
        ENDWHILE


        $strtask2 = "08PS  " + $strtask2
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 6) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 7) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 8) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 9)  
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
            
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile


ENDDFS


DFS togglePress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000


        $strtask2 = "04DI  "
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
                  
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile
        G4 P0.15

ENDDFS

DFS alignNozzle

	$zStart = $Q
	$delta = $R
	$nozzle = $L
	$floor = $I
	$deltafast = $J

	;#$Ax = 483
	;#$Ay = 317
	;#$Bx = 379
	;#$By = 317
	;#$Cx = 275
	;#$Cy = 317
	;#$Dx = 196
	;#$Dy = 317
	;#$Px = 148
	;#$Py = 345
	
	$Ax = 606.662
	$Ay = 352.920
	$Bx = 502.662
	$By = 352.920
	$Cx = 398.662
	$Cy = 352.920
	$Dx = 319.662
	$Dy = 352.920
	$Px = 148
	$Py = 345
	
	$comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
	
	G90
	G1 A-0.5 B-0.5 C-0.5 D-0.5 F$fastfeed
	IF $nozzle = 1
		$xStart = $Ax
		$yStart = $Ay
		G1 X$xStart Y$yStart
		G1 A$zStart
	ELSE IF $nozzle = 2
		$xStart = $Bx
		$yStart = $By
		G1 X$xStart Y$yStart
		G1 B$zStart
	ELSE IF $nozzle = 3
		$xStart = $Cx
		$yStart = $Cy
		G1 X$xStart Y$yStart
		G1 C$zStart
	ELSE IF $nozzle = 4
		$xStart = $Dx
		$yStart = $Dy
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE IF $nozzle = 5
		$xStart = $Px
		$yStart = $Py
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE 
		G1 A-1 B-1 C-1 D-1
	ENDIF
	G91


	$found = 0
	WHILE $found != -1
	
		FILEWRITE $comport "M0,0"
		FILEREAD $comport 0 $strglob0	
		$found = STRFIND($strglob0, "--", 1)
		IF $nozzle == 1
			$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==2
			$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==3
			$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==4
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==5
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ENDIF
		
		IF ($posZ - $deltafast) < $floor
			$found = -1
		ELSE
			IF $nozzle == 1
				G1 A-$deltafast F$midfeed
				ELSEIF $nozzle == 2
				G1 B-$deltafast F$midfeed
				ELSEIF $nozzle == 3
				G1 C-$deltafast F$midfeed
				ELSEIF $nozzle == 4
				G1 D-$deltafast F$midfeed
				ELSEIF $nozzle == 5
				G1 D-$deltafast F$midfeed
				ELSE
				MSGDISPLAY 1 "something is messed up"
			ENDIF
		ENDIF
	ENDWHILE

; move up slightly and redo it again slowly
IF $nozzle == 1
			G1 A3.5 F$fastfeed
			ELSEIF $nozzle == 2
			G1 B3.5 F$fastfeed
			ELSEIF $nozzle == 3
			G1 C3.5 F$fastfeed
			ELSEIF $nozzle == 4
			G1 D3.5 F$fastfeed
			ELSEIF $nozzle == 5
			G1 D3.5 F$fastfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF



	$found = 0
WHILE $found != -1

	FILEWRITE $comport "M0,0"
	FILEREAD $comport 0 $strglob0	
	$found = STRFIND($strglob0, "--", 1)
	IF $nozzle ==1
		$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==2
		$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==3
		$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==4
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==5
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
	ENDIF
	
	IF ($posZ - $deltafast) < $floor
		$found = -1
	ELSE
		IF $nozzle == 1
			G1 A-$delta F$slowfeed
			ELSEIF $nozzle == 2
			G1 B-$delta F$slowfeed
			ELSEIF $nozzle == 3
			G1 C-$delta F$slowfeed
			ELSEIF $nozzle == 4
			G1 D-$delta F$slowfeed
			ELSEIF $nozzle == 5
			G1 D-$delta F$slowfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
		ENDIF
	ENDIF
ENDWHILE

IF $nozzle == 1
			G1 A-0.4 F$midfeed
			ELSEIF $nozzle == 2
			G1 B-0.4 F$midfeed
			ELSEIF $nozzle == 3
			G1 C-0.4 F$midfeed
			ELSEIF $nozzle == 4
			G1 D-0.4 F$midfeed
			ELSEIF $nozzle == 5
			G1 D-0.4 F$midfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF

;Dwell to get accurate Reading
DWELL 0.75

; read from keyance
FILEWRITE $comport "M0,0"
FILEREAD $comport 0 $strglob0

; Assign Reading To Variables

	$comma1 = STRFIND($strglob0, ",", 1)
	$comma1plus=$comma1+1
	$STRGLOB1 = STRMID ($STRGLOB0, $comma1plus, 40)
	$comma2 = STRFIND($strglob1, ",", 1)
	$comma2 = $comma2 + $comma1
	$comma2plus = $comma2+2
	$STRGLOB2 = STRMID ($STRGLOB0, $comma1plus, $comma2)
	$STRGLOB3 = STRMID ($STRGLOB0, $comma2plus, 40)

		IF $nozzle = 1
			$Ax_dif = STRTODBL($STRGLOB2)
			$Ay_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 2
			$Bx_dif = STRTODBL($STRGLOB2)
			$By_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 3
			$Cx_dif = STRTODBL($STRGLOB2)
			$Cy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 4
			$Dx_dif = STRTODBL($STRGLOB2)
			$Dy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 5
			$Px_dif = STRTODBL($STRGLOB2)
			$Py_dif = STRTODBL($STRGLOB3)
		ENDIF

	G90
	G1 A-1 B-1 C-1 D-1 F$fastfeed
	G91
	
	

	FILECLOSE $comport
ENDDFS



DFS alignZeroNozzle

	$zStart = $Q
	$delta = $R
	$nozzle = $L
	$floor = $I
	$deltafast = $J

        ;#$Ax = 483
	;#$Ay = 317
	;#$Bx = 379
	;#$By = 317
	;#$Cx = 275
	;#$Cy = 317
	;#$Dx = 196
	;#$Dy = 317
	;#$Px = 148
	;#$Py = 345
	
	$Ax = 586.075
	$Ay = 367.8285
	$Bx = 482.075
	$By = 367.8285
	$Cx = 378.075
	$Cy = 367.8285
	$Dx = 299.075
	$Dy = 367.8285
	$Px = 148
	$Py = 345
	
	$xOffset = 0.7
	$yOffset = -0.7
	$DO7.0=0
	$comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
	
	
	FILEWRITE $comport "PW,3" ; Select Program #3
	FILEREAD $comport 0 $strglob1

	
	G90
	G1 A-0.5 B-0.5 C-0.5 D-0.5 F$fastfeed
	IF $nozzle = 1
		$xStart = $Ax
		$yStart = $Ay
		G1 X$xStart Y$yStart
		G1 A$zStart
	ELSE IF $nozzle = 2
		$xStart = $Bx
		$yStart = $By
		G1 X$xStart Y$yStart
		G1 B$zStart
	ELSE IF $nozzle = 3
		$xStart = $Cx
		$yStart = $Cy
		G1 X$xStart Y$yStart
		G1 C$zStart
	ELSE IF $nozzle = 4
		$xStart = $Dx
		$yStart = $Dy
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE IF $nozzle = 5
		$xStart = $Px
		$yStart = $Py
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE 
		G1 A-1 B-1 C-1 D-1
	ENDIF
	G91


	$found = 0
	WHILE $found != -1
	
		FILEWRITE $comport "M0,0"
		FILEREAD $comport 0 $strglob0	
		
		$found = STRFIND($strglob0, "--", 1)
		IF $nozzle == 1
			$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==2
			$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==3
			$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==4
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==5
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ENDIF
		
		
		IF ($posZ - $deltafast) < $floor
			$found = -1
		ELSE
			IF $nozzle == 1
				G1 A-$deltafast F$midfeed
				ELSEIF $nozzle == 2
				G1 B-$deltafast F$midfeed
				ELSEIF $nozzle == 3
				G1 C-$deltafast F$midfeed
				ELSEIF $nozzle == 4
				G1 D-$deltafast F$midfeed
				ELSEIF $nozzle == 5
				G1 D-$deltafast F$midfeed
				ELSE
				MSGDISPLAY 1 "something is messed up"
			ENDIF
		ENDIF
		
	ENDWHILE

; move up slightly and redo it again slowly
IF $nozzle == 1
			G1 A3.5 F$fastfeed
			ELSEIF $nozzle == 2
			G1 B3.5 F$fastfeed
			ELSEIF $nozzle == 3
			G1 C3.5 F$fastfeed
			ELSEIF $nozzle == 4
			G1 D3.5 F$fastfeed
			ELSEIF $nozzle == 5
			G1 D3.5 F$fastfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF



	$found = 0
WHILE $found != -1

	FILEWRITE $comport "M0,0"
	FILEREAD $comport 0 $strglob0	
	$found = STRFIND($strglob0, "--", 1)
	IF $nozzle ==1
		$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==2
		$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==3
		$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==4
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==5
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
	ENDIF
	
	IF ($posZ - $deltafast) < $floor
		$found = -1
	ELSE
		IF $nozzle == 1
			G1 A-$delta F$slowfeed
			ELSEIF $nozzle == 2
			G1 B-$delta F$slowfeed
			ELSEIF $nozzle == 3
			G1 C-$delta F$slowfeed
			ELSEIF $nozzle == 4
			G1 D-$delta F$slowfeed
			ELSEIF $nozzle == 5
			G1 D-$delta F$slowfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
		ENDIF
	ENDIF
ENDWHILE

IF $nozzle == 1
			G1 A-0.4 F$midfeed
			ELSEIF $nozzle == 2
			G1 B-0.4 F$midfeed
			ELSEIF $nozzle == 3
			G1 C-0.4 F$midfeed
			ELSEIF $nozzle == 4
			G1 D-0.4 F$midfeed
			ELSEIF $nozzle == 5
			G1 D-0.4 F$midfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF

;Dwell to get accurate Reading
DWELL 0.75

; read from keyance
FILEWRITE $comport "M0,0"
FILEREAD $comport 0 $strglob0

; Assign Reading To Variables

	$comma1 = STRFIND($strglob0, ",", 1)
	$comma1plus=$comma1+1
	$STRGLOB1 = STRMID ($STRGLOB0, $comma1plus, 40)
	$comma2 = STRFIND($strglob1, ",", 1)
	$comma2 = $comma2 + $comma1
	$comma2plus = $comma2+2
	$STRGLOB2 = STRMID ($STRGLOB0, $comma1plus, $comma2)
	$STRGLOB3 = STRMID ($STRGLOB0, $comma2plus, 40)

		IF $nozzle = 1
			$Ax_dif = STRTODBL($STRGLOB2)
			$Ay_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 2
			$Bx_dif = STRTODBL($STRGLOB2)
			$By_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 3
			$Cx_dif = STRTODBL($STRGLOB2)
			$Cy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 4
			$Dx_dif = STRTODBL($STRGLOB2)
			$Dy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 5
			$Px_dif = STRTODBL($STRGLOB2)
			$Py_dif = STRTODBL($STRGLOB3)
		ENDIF


;switch keyence programs
$DO7.0=1
FILEWRITE $comport "PW,4" ; Select Program #4
FILEREAD $comport 0 $strglob1

; Attain zero value
        IF $nozzle = 1
			G91
			G1 X-$Ax_dif Y-$Ay_dif F5
			G1 X$xOffset Y$yOffset
			$zMeasureA = AXISSTATUS(A, DATAITEM_PositionFeedback)
			DWELL 3
			CALL zHold Q3 R0.075 L0.25
	                $Az_dif = $z_dif
	                MSGDISPLAY 1 "Az_dif: " + $Az_dif
			MSGDISPLAY 1 "zMeasureA: " + $zMeasureA
			
			ELSEIF $nozzle == 2
			G91
			G1 X-$Bx_dif Y-$By_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureB = AXISSTATUS(B, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Bz_dif = $z_dif
	                MSGDISPLAY 1 "Bz_dif: " + $Bz_dif
			MSGDISPLAY 1 "zMeasureB: " + $zMeasureB
	                
			ELSEIF $nozzle == 3
			G91
			G1 X-$Cx_dif Y-$Cy_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureC = AXISSTATUS(C, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Cz_dif = $z_dif
	                MSGDISPLAY 1 "Cz_dif: " + $Cz_dif
			MSGDISPLAY 1 "zMeasureC: " + $zMeasureC
	                
			ELSEIF $nozzle == 4
			G91
			G1 X-$Dx_dif Y-$Dy_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureD = AXISSTATUS(D, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Dz_dif = $z_dif
	                MSGDISPLAY 1 "Dz_dif: " + $Dz_dif
			MSGDISPLAY 1 "zMeasureD: " + $zMeasureD
		ENDIF

$DO7.0=0
FILEWRITE $comport "PW,3" ; Select Program #3
FILEREAD $comport 0 $strglob1
	G90
	G1 A-1 B-1 C-1 D-1 F$fastfeed
	G91
	
	

	FILECLOSE $comport
ENDDFS

DFS zHold
    $zSweepRange = $Q
    $zSweepStep = $R
    $zDwell = $L
    $start = (($zSweepRange/2)/1.414213)
    $x_dist = (($zSweepRange)/1.414213)
    
    G91
    G1 X-($start) Y$start F2

    FILEWRITE $comport "U1"
    FILEREAD $comport 0 $strglob0
    G1 X$x_dist Y-$x_dist F0.5
    FILEWRITE $comport "L1,0"
    FILEREAD $comport 0 $strglob0
    $STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
    $z_dif = STRTODBL($STRGLOB1)

ENDDFS
        


DFS zSweep
$zSweepRange = $Q
$zSweepStep = $R
$zDwell = $L


$indicator = 0
$z_num = 0
$numsteps = ($zSweepRange/$zSweepStep)
$start = (($zSweepRange/2)/1.414213)
$step = $zSweepStep/1.414213
$z_dif=6
$count = 0
G91
G1 X-($start) Y$start F2

WHILE $count<$numsteps
	
	
	Dwell $zDwell
	FILEWRITE $comport "M2,0"
	FILEREAD $comport 0 $strglob0
	$STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
	$tempdistance = STRTODBL($STRGLOB1)
	IF $tempdistance < $z_dif
	        $z_dif=$tempdistance
	        $z_past = $z_dif + 1
		;$indicator = 1
                MSGDISPLAY 1 "zdif recorded: " + $z_dif
	ENDIF
	IF $indicator = 1
	       IF $tempdistance > $z_past
	           $z_num = $z_num + 1
	       ELSE 
	           $z_num = 0
	       ENDIF
	ENDIF
	IF $z_num = 5
	   GOTO quit_loop
	ENDIF
	$count = $count + 1
	G1 X($step) Y-$step F2
ENDWHILE
:quit_loop
ENDDFS

DFS save_value

    $nozzle = $Q
IF $nozzle = 1
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_1.txt", 0
    FILEWRITE $align_save "$Ax_dif = " + $Ax_dif
    FILEWRITE $align_save "$Ay_dif = " + $Ay_dif
    FILEWRITE $align_save "$zMeasureA = " + $zMeasureA
    FILEWRITE $align_save "$Az_dif = " + $Az_dif
ENDIF
IF $nozzle = 2
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_2.txt", 0
    FILEWRITE $align_save "$Bx_dif = " + $Bx_dif
    FILEWRITE $align_save "$By_dif = " + $By_dif
    FILEWRITE $align_save "$zMeasureB = " + $zMeasureB
    FILEWRITE $align_save "$Bz_dif = " + $Bz_dif
ENDIF
IF $nozzle = 3
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_3.txt", 0
    FILEWRITE $align_save "$Cx_dif = " + $Cx_dif
    FILEWRITE $align_save "$Cy_dif = " + $Cy_dif
    FILEWRITE $align_save "$zMeasureC = " + $zMeasureC
    FILEWRITE $align_save "$Cz_dif = " + $Cz_dif
ENDIF
IF $nozzle = 4
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_4.txt", 0
    FILEWRITE $align_save "$Dx_dif = " + $Dx_dif
    FILEWRITE $align_save "$Dy_dif = " + $Dy_dif
    FILEWRITE $align_save "$zMeasureD = " + $zMeasureD
    FILEWRITE $align_save "$Dz_dif = " + $Dz_dif
ENDIF


FILECLOSE $align_save
ENDDFS
