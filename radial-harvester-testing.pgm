DVAR $hFile
DVAR $cCheck
DVAR $press
DVAR $length
DVAR $lame
DVAR $comport


DVAR $found, $floor $delta $deltafast $Ax $Ay $Bx $By $Cx $Cy $Dx $Dy $Px $Py $posA $posB $posC $posD $posZ $fastfeed $midfeed $slowfeed $Astart $Bstart $Cstart $Dstart $Pstart $comma1 $comma2 $comma1plus $comma2plus
DVAR $Ax_dif $Ay_dif $Bx_dif $By_dif $Cx_dif $Cy_dif $Dx_dif $Dy_dif $Px_dif $Py_dif
DVAR $nozzle $nozzleA $nozzleB $nozzleC $nozzleD $profilometerRod $xStart $yStart $zStart 
DVAR $zMeasureA $zMeasureB $zMeasureC $zMeasureD $Az_dif $Bz_dif $Cz_dif $Dz_dif $xOffset $yOffset
DVAR $zA $zB $zC $zD $check
DVAR $zSweepRange $zSweepStep $numsteps $tempdistance $zDwell $count $z_dif $z_past $z_num $indicator $step $start $x_dist
DVAR $align_save
FILECLOSE 

$floor = -72
$deltafast = 1
$delta = 0.1
$fastfeed = 40
$midfeed = 10
$slowfeed = 2
$Astart = -15
$Bstart = -15
$Cstart = -15
$Dstart = -15
$Pstart = -15
$nozzleA=1
$nozzleB=2
$nozzleC=3
$nozzleD=4
$profilometerRod = 5

$Ax = 586.075
$Ay = 367.8285
$Bx = 482.075
$By = 367.8285
$Cx = 378.075
$Cy = 367.8285
$Dx = 299.075
$Dy = 367.8285
$Px = 148
$Py = 345

$DO0.0=0
$DO1.0=0
$DO2.0=0
$DO3.0=0
Primary ; sets primary units mm and s
G65 F2000; accel speed mm/s^2
G66 F2000;accel speed mm/s^2
ENABLE X Y A B C D U
POSOFFSET CLEAR X Y U A B C D
G91 ;start off in relative mode

$Ax_dif = 0.734700
$Ay_dif = 0.000050
$zMeasureA = -34.699996
$Az_dif = 2.468700

$Bx_dif = -0.731200
$By_dif = -0.165600
$zMeasureB = -36.600001
$Bz_dif = 2.490550

$Cx_dif = 0.000000
$Cy_dif = 0.000000
$zMeasureC = 0.000000
$Cz_dif = 0.000000

$Dx_dif = 0.000000
$Dy_dif = 0.000000
$zMeasureD = 0.000000
$Dz_dif = 0.000000

F30
Call save_value Q1
Call save_value Q2
Call save_value Q3
Call save_value Q4
F30
G90
G1 A-2.000000 C-2.000000 B-2.000000 D-2.000000
G91
G90
G1 X352.000000 Y70.240000
G91
G1 X$Ax_dif  Y$Ay_dif
G92 X0.000000 Y0.000000
Call togglePress P4
$DO6.0=1
G4 P0.75
$DO6.0=0
Call togglePress P4
G4 P0.5
Call togglePress P4
$zB = -82.5331
$zA = $zB + ($zMeasureA - $zMeasureB) + ($Bz_dif-$Az_dif)
$zC = $zB + ($zMeasureC - $zMeasureB) + ($Bz_dif-$Cz_dif)
$zD = $zB + ($zMeasureD - $zMeasureB) + ($Bz_dif-$Dz_dif)
G90
G1 A-5.000000 C-5.000000 B-5.000000 D-5.000000
G91
G92 A(-$zA-5) B(-$zB-5) C(-$zC - 5) D(-$zD - 5)
F40
G90
G1 X0.000000 Y0.000000
G91
G4 P0.25
;----------nozzle change------------
G90
G1 A50.000000
G91
G1 X($Bx-$Ax-($Bx_dif-$Ax_dif))  Y($Ay-$By+($Ay_dif-$By_dif))
G92 X0.000000 Y0.000000
F15
G90
G1 X20.000000 Y-20.000000
G91
Call setPress P4 Q50
G90
G1 B0.200000
G91
F6
$DO1.0=1
;WARNING! meander spacing updated from 0.34 to 0.338983050847
G91
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
G1 X0.338983
G1 Y-20.000000
G1 X0.338983
G1 Y20.000000
$DO1.0=0
Call togglePress P4
;#################################### Code ##########################################

M2

;##########Functions############;
DFS setPress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000
                             
        $press = $Q * 10.0                             
        $strtask2 = DBLTOSTR( $press , 0 )  
      
      
        $length = STRLEN( $strtask2 )      
        WHILE $length < 4.0
                $strtask2 = "0" + $strtask2    
                $length = STRLEN( $strtask2 ) 
        ENDWHILE


        $strtask2 = "08PS  " + $strtask2
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 6) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 7) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 8) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 9)  
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
            
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile


ENDDFS


DFS togglePress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000


        $strtask2 = "04DI  "
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
                  
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile
        G4 P0.15

ENDDFS

DFS alignNozzle

	$zStart = $Q
	$delta = $R
	$nozzle = $L
	$floor = $I
	$deltafast = $J

	;#$Ax = 483
	;#$Ay = 317
	;#$Bx = 379
	;#$By = 317
	;#$Cx = 275
	;#$Cy = 317
	;#$Dx = 196
	;#$Dy = 317
	;#$Px = 148
	;#$Py = 345
	
	$Ax = 606.662
	$Ay = 352.920
	$Bx = 502.662
	$By = 352.920
	$Cx = 398.662
	$Cy = 352.920
	$Dx = 319.662
	$Dy = 352.920
	$Px = 148
	$Py = 345
	
	$comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
	
	G90
	G1 A-0.5 B-0.5 C-0.5 D-0.5 F$fastfeed
	IF $nozzle = 1
		$xStart = $Ax
		$yStart = $Ay
		G1 X$xStart Y$yStart
		G1 A$zStart
	ELSE IF $nozzle = 2
		$xStart = $Bx
		$yStart = $By
		G1 X$xStart Y$yStart
		G1 B$zStart
	ELSE IF $nozzle = 3
		$xStart = $Cx
		$yStart = $Cy
		G1 X$xStart Y$yStart
		G1 C$zStart
	ELSE IF $nozzle = 4
		$xStart = $Dx
		$yStart = $Dy
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE IF $nozzle = 5
		$xStart = $Px
		$yStart = $Py
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE 
		G1 A-1 B-1 C-1 D-1
	ENDIF
	G91


	$found = 0
	WHILE $found != -1
	
		FILEWRITE $comport "M0,0"
		FILEREAD $comport 0 $strglob0	
		$found = STRFIND($strglob0, "--", 1)
		IF $nozzle == 1
			$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==2
			$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==3
			$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==4
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==5
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ENDIF
		
		IF ($posZ - $deltafast) < $floor
			$found = -1
		ELSE
			IF $nozzle == 1
				G1 A-$deltafast F$midfeed
				ELSEIF $nozzle == 2
				G1 B-$deltafast F$midfeed
				ELSEIF $nozzle == 3
				G1 C-$deltafast F$midfeed
				ELSEIF $nozzle == 4
				G1 D-$deltafast F$midfeed
				ELSEIF $nozzle == 5
				G1 D-$deltafast F$midfeed
				ELSE
				MSGDISPLAY 1 "something is messed up"
			ENDIF
		ENDIF
	ENDWHILE

; move up slightly and redo it again slowly
IF $nozzle == 1
			G1 A3.5 F$fastfeed
			ELSEIF $nozzle == 2
			G1 B3.5 F$fastfeed
			ELSEIF $nozzle == 3
			G1 C3.5 F$fastfeed
			ELSEIF $nozzle == 4
			G1 D3.5 F$fastfeed
			ELSEIF $nozzle == 5
			G1 D3.5 F$fastfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF



	$found = 0
WHILE $found != -1

	FILEWRITE $comport "M0,0"
	FILEREAD $comport 0 $strglob0	
	$found = STRFIND($strglob0, "--", 1)
	IF $nozzle ==1
		$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==2
		$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==3
		$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==4
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==5
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
	ENDIF
	
	IF ($posZ - $deltafast) < $floor
		$found = -1
	ELSE
		IF $nozzle == 1
			G1 A-$delta F$slowfeed
			ELSEIF $nozzle == 2
			G1 B-$delta F$slowfeed
			ELSEIF $nozzle == 3
			G1 C-$delta F$slowfeed
			ELSEIF $nozzle == 4
			G1 D-$delta F$slowfeed
			ELSEIF $nozzle == 5
			G1 D-$delta F$slowfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
		ENDIF
	ENDIF
ENDWHILE

IF $nozzle == 1
			G1 A-0.4 F$midfeed
			ELSEIF $nozzle == 2
			G1 B-0.4 F$midfeed
			ELSEIF $nozzle == 3
			G1 C-0.4 F$midfeed
			ELSEIF $nozzle == 4
			G1 D-0.4 F$midfeed
			ELSEIF $nozzle == 5
			G1 D-0.4 F$midfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF

;Dwell to get accurate Reading
DWELL 0.75

; read from keyance
FILEWRITE $comport "M0,0"
FILEREAD $comport 0 $strglob0

; Assign Reading To Variables

	$comma1 = STRFIND($strglob0, ",", 1)
	$comma1plus=$comma1+1
	$STRGLOB1 = STRMID ($STRGLOB0, $comma1plus, 40)
	$comma2 = STRFIND($strglob1, ",", 1)
	$comma2 = $comma2 + $comma1
	$comma2plus = $comma2+2
	$STRGLOB2 = STRMID ($STRGLOB0, $comma1plus, $comma2)
	$STRGLOB3 = STRMID ($STRGLOB0, $comma2plus, 40)

		IF $nozzle = 1
			$Ax_dif = STRTODBL($STRGLOB2)
			$Ay_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 2
			$Bx_dif = STRTODBL($STRGLOB2)
			$By_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 3
			$Cx_dif = STRTODBL($STRGLOB2)
			$Cy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 4
			$Dx_dif = STRTODBL($STRGLOB2)
			$Dy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 5
			$Px_dif = STRTODBL($STRGLOB2)
			$Py_dif = STRTODBL($STRGLOB3)
		ENDIF

	G90
	G1 A-1 B-1 C-1 D-1 F$fastfeed
	G91
	
	

	FILECLOSE $comport
ENDDFS



DFS alignZeroNozzle

	$zStart = $Q
	$delta = $R
	$nozzle = $L
	$floor = $I
	$deltafast = $J

        ;#$Ax = 483
	;#$Ay = 317
	;#$Bx = 379
	;#$By = 317
	;#$Cx = 275
	;#$Cy = 317
	;#$Dx = 196
	;#$Dy = 317
	;#$Px = 148
	;#$Py = 345
	
	$Ax = 586.075
	$Ay = 367.8285
	$Bx = 482.075
	$By = 367.8285
	$Cx = 378.075
	$Cy = 367.8285
	$Dx = 299.075
	$Dy = 367.8285
	$Px = 148
	$Py = 345
	
	$xOffset = 0.7
	$yOffset = -0.7
	$DO7.0=0
	$comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
	
	
	FILEWRITE $comport "PW,3" ; Select Program #3
	FILEREAD $comport 0 $strglob1

	
	G90
	G1 A-0.5 B-0.5 C-0.5 D-0.5 F$fastfeed
	IF $nozzle = 1
		$xStart = $Ax
		$yStart = $Ay
		G1 X$xStart Y$yStart
		G1 A$zStart
	ELSE IF $nozzle = 2
		$xStart = $Bx
		$yStart = $By
		G1 X$xStart Y$yStart
		G1 B$zStart
	ELSE IF $nozzle = 3
		$xStart = $Cx
		$yStart = $Cy
		G1 X$xStart Y$yStart
		G1 C$zStart
	ELSE IF $nozzle = 4
		$xStart = $Dx
		$yStart = $Dy
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE IF $nozzle = 5
		$xStart = $Px
		$yStart = $Py
		G1 X$xStart Y$yStart
		G1 D$zStart
	ELSE 
		G1 A-1 B-1 C-1 D-1
	ENDIF
	G91


	$found = 0
	WHILE $found != -1
	
		FILEWRITE $comport "M0,0"
		FILEREAD $comport 0 $strglob0	
		
		$found = STRFIND($strglob0, "--", 1)
		IF $nozzle == 1
			$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==2
			$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==3
			$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==4
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
			ELSEIF $nozzle ==5
			$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ENDIF
		
		
		IF ($posZ - $deltafast) < $floor
			$found = -1
		ELSE
			IF $nozzle == 1
				G1 A-$deltafast F$midfeed
				ELSEIF $nozzle == 2
				G1 B-$deltafast F$midfeed
				ELSEIF $nozzle == 3
				G1 C-$deltafast F$midfeed
				ELSEIF $nozzle == 4
				G1 D-$deltafast F$midfeed
				ELSEIF $nozzle == 5
				G1 D-$deltafast F$midfeed
				ELSE
				MSGDISPLAY 1 "something is messed up"
			ENDIF
		ENDIF
		
	ENDWHILE

; move up slightly and redo it again slowly
IF $nozzle == 1
			G1 A3.5 F$fastfeed
			ELSEIF $nozzle == 2
			G1 B3.5 F$fastfeed
			ELSEIF $nozzle == 3
			G1 C3.5 F$fastfeed
			ELSEIF $nozzle == 4
			G1 D3.5 F$fastfeed
			ELSEIF $nozzle == 5
			G1 D3.5 F$fastfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF



	$found = 0
WHILE $found != -1

	FILEWRITE $comport "M0,0"
	FILEREAD $comport 0 $strglob0	
	$found = STRFIND($strglob0, "--", 1)
	IF $nozzle ==1
		$posZ = AXISSTATUS(A, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==2
		$posZ = AXISSTATUS(B, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==3
		$posZ = AXISSTATUS(C, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==4
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
		ELSEIF $nozzle ==5
		$posZ = AXISSTATUS(D, DATAITEM_PositionFeedback)
	ENDIF
	
	IF ($posZ - $deltafast) < $floor
		$found = -1
	ELSE
		IF $nozzle == 1
			G1 A-$delta F$slowfeed
			ELSEIF $nozzle == 2
			G1 B-$delta F$slowfeed
			ELSEIF $nozzle == 3
			G1 C-$delta F$slowfeed
			ELSEIF $nozzle == 4
			G1 D-$delta F$slowfeed
			ELSEIF $nozzle == 5
			G1 D-$delta F$slowfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
		ENDIF
	ENDIF
ENDWHILE

IF $nozzle == 1
			G1 A-0.4 F$midfeed
			ELSEIF $nozzle == 2
			G1 B-0.4 F$midfeed
			ELSEIF $nozzle == 3
			G1 C-0.4 F$midfeed
			ELSEIF $nozzle == 4
			G1 D-0.4 F$midfeed
			ELSEIF $nozzle == 5
			G1 D-0.4 F$midfeed
			ELSE
			MSGDISPLAY 1 "something is messed up"
ENDIF

;Dwell to get accurate Reading
DWELL 0.75

; read from keyance
FILEWRITE $comport "M0,0"
FILEREAD $comport 0 $strglob0

; Assign Reading To Variables

	$comma1 = STRFIND($strglob0, ",", 1)
	$comma1plus=$comma1+1
	$STRGLOB1 = STRMID ($STRGLOB0, $comma1plus, 40)
	$comma2 = STRFIND($strglob1, ",", 1)
	$comma2 = $comma2 + $comma1
	$comma2plus = $comma2+2
	$STRGLOB2 = STRMID ($STRGLOB0, $comma1plus, $comma2)
	$STRGLOB3 = STRMID ($STRGLOB0, $comma2plus, 40)

		IF $nozzle = 1
			$Ax_dif = STRTODBL($STRGLOB2)
			$Ay_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 2
			$Bx_dif = STRTODBL($STRGLOB2)
			$By_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 3
			$Cx_dif = STRTODBL($STRGLOB2)
			$Cy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 4
			$Dx_dif = STRTODBL($STRGLOB2)
			$Dy_dif = STRTODBL($STRGLOB3)
			ELSEIF $nozzle == 5
			$Px_dif = STRTODBL($STRGLOB2)
			$Py_dif = STRTODBL($STRGLOB3)
		ENDIF


;switch keyence programs
$DO7.0=1
FILEWRITE $comport "PW,4" ; Select Program #4
FILEREAD $comport 0 $strglob1

; Attain zero value
        IF $nozzle = 1
			G91
			G1 X-$Ax_dif Y-$Ay_dif F5
			G1 X$xOffset Y$yOffset
			$zMeasureA = AXISSTATUS(A, DATAITEM_PositionFeedback)
			DWELL 3
			CALL zHold Q3 R0.075 L0.25
	                $Az_dif = $z_dif
	                MSGDISPLAY 1 "Az_dif: " + $Az_dif
			MSGDISPLAY 1 "zMeasureA: " + $zMeasureA
			
			ELSEIF $nozzle == 2
			G91
			G1 X-$Bx_dif Y-$By_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureB = AXISSTATUS(B, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Bz_dif = $z_dif
	                MSGDISPLAY 1 "Bz_dif: " + $Bz_dif
			MSGDISPLAY 1 "zMeasureB: " + $zMeasureB
	                
			ELSEIF $nozzle == 3
			G91
			G1 X-$Cx_dif Y-$Cy_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureC = AXISSTATUS(C, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Cz_dif = $z_dif
	                MSGDISPLAY 1 "Cz_dif: " + $Cz_dif
			MSGDISPLAY 1 "zMeasureC: " + $zMeasureC
	                
			ELSEIF $nozzle == 4
			G91
			G1 X-$Dx_dif Y-$Dy_dif F5
			G1 X$xOffset Y$yOffset
			DWELL 3
			$zMeasureD = AXISSTATUS(D, DATAITEM_PositionFeedback)
			CALL zHold Q3 R0.025 L0.25
	                $Dz_dif = $z_dif
	                MSGDISPLAY 1 "Dz_dif: " + $Dz_dif
			MSGDISPLAY 1 "zMeasureD: " + $zMeasureD
		ENDIF

$DO7.0=0
FILEWRITE $comport "PW,3" ; Select Program #3
FILEREAD $comport 0 $strglob1
	G90
	G1 A-1 B-1 C-1 D-1 F$fastfeed
	G91
	
	

	FILECLOSE $comport
ENDDFS

DFS zHold
    $zSweepRange = $Q
    $zSweepStep = $R
    $zDwell = $L
    $start = (($zSweepRange/2)/1.414213)
    $x_dist = (($zSweepRange)/1.414213)
    $z_dif = 8
    G91
    G1 X-($start) Y$start F2

    FILEWRITE $comport "U1"
    FILEREAD $comport 0 $strglob0
    G1 X$x_dist Y-$x_dist F0.25
    FILEWRITE $comport "L1,0"
    FILEREAD $comport 0 $strglob0
    $STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
    $z_dif = STRTODBL($STRGLOB1)
    WHILE $z_dif < 0.1
        FILECLOSE $comport
       
        $z_dif = 8
        G91
        G1 X-$x_dist Y$x_dist F4
        
        $comport = FILEOPEN "COM8", 2
	COMMINIT $comport, "baud=115200 parity=N data=8 stop=1" ; Initialize comport
	COMMSETTIMEOUT $comport, -1, 0, 0
        FILEREAD $comport 0 $strglob5
        FILEWRITE $comport "PW,4" ; Select Program #4
        FILEREAD $comport 0 $strglob1
        DWELL(0.25)
        FILEWRITE $comport "U1"
        FILEREAD $comport 0 $strglob0
        G1 X$x_dist Y-$x_dist F0.1
        FILEWRITE $comport "L1,0"
        DWELL(0.25)
        FILEREAD $comport 0 $strglob0
        $STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
        $z_dif = STRTODBL($STRGLOB1)
        IF $z_dif > 7.8
            $z_dif = 0
        ENDIF
    ENDWHILE

ENDDFS
        


DFS zSweep
$zSweepRange = $Q
$zSweepStep = $R
$zDwell = $L


$indicator = 0
$z_num = 0
$numsteps = ($zSweepRange/$zSweepStep)
$start = (($zSweepRange/2)/1.414213)
$step = $zSweepStep/1.414213
$z_dif=6
$count = 0
G91
G1 X-($start) Y$start F2

WHILE $count<$numsteps
	
	
	Dwell $zDwell
	FILEWRITE $comport "M2,0"
	FILEREAD $comport 0 $strglob0
	$STRGLOB1 = STRMID ($STRGLOB0, 4, -1)
	$tempdistance = STRTODBL($STRGLOB1)
	IF $tempdistance < $z_dif
	        IF $tempdistance > 0
	           $z_dif=$tempdistance
	           $z_past = $z_dif + 1
		  ;$indicator = 1
                    MSGDISPLAY 1 "zdif recorded: " + $z_dif
                ENDIF    
	ENDIF
	IF $indicator = 1
	       IF $tempdistance > $z_past
	           $z_num = $z_num + 1
	       ELSE 
	           $z_num = 0
	       ENDIF
	ENDIF
	IF $z_num = 5
	   GOTO quit_loop
	ENDIF
	$count = $count + 1
	G1 X($step) Y-$step F2
ENDWHILE
:quit_loop
ENDDFS

DFS save_value

    $nozzle = $Q
IF $nozzle = 1
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_1.txt", 0
    FILEWRITE $align_save "$Ax_dif = " + $Ax_dif
    FILEWRITE $align_save "$Ay_dif = " + $Ay_dif
    FILEWRITE $align_save "$zMeasureA = " + $zMeasureA
    FILEWRITE $align_save "$Az_dif = " + $Az_dif
ENDIF
IF $nozzle = 2
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_2.txt", 0
    FILEWRITE $align_save "$Bx_dif = " + $Bx_dif
    FILEWRITE $align_save "$By_dif = " + $By_dif
    FILEWRITE $align_save "$zMeasureB = " + $zMeasureB
    FILEWRITE $align_save "$Bz_dif = " + $Bz_dif
ENDIF
IF $nozzle = 3
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_3.txt", 0
    FILEWRITE $align_save "$Cx_dif = " + $Cx_dif
    FILEWRITE $align_save "$Cy_dif = " + $Cy_dif
    FILEWRITE $align_save "$zMeasureC = " + $zMeasureC
    FILEWRITE $align_save "$Cz_dif = " + $Cz_dif
ENDIF
IF $nozzle = 4
    $align_save = FILEOPEN "C:\Users\Lewis Group\Desktop\Alignment\alignment_values_4.txt", 0
    FILEWRITE $align_save "$Dx_dif = " + $Dx_dif
    FILEWRITE $align_save "$Dy_dif = " + $Dy_dif
    FILEWRITE $align_save "$zMeasureD = " + $zMeasureD
    FILEWRITE $align_save "$Dz_dif = " + $Dz_dif
ENDIF


FILECLOSE $align_save
ENDDFS
